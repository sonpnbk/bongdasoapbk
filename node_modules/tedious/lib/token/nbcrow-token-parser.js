// Generated by CoffeeScript 1.10.0
var parser, sprintf, valueParse;

valueParse = require('../value-parser');

sprintf = require('sprintf').sprintf;

parser = function(buffer, columnsMetaData, options) {
  var bitmap, byte, bytes, column, columnMetaData, columns, i, index, j, k, l, len, len1, length, value;
  length = Math.ceil(columnsMetaData.length / 8);
  bytes = buffer.readBuffer(length);
  bitmap = [];
  for (j = 0, len = bytes.length; j < len; j++) {
    byte = bytes[j];
    for (i = k = 0; k <= 7; i = ++k) {
      bitmap.push(byte & (1 << i) ? true : false);
    }
  }
  columns = options.useColumnNames ? {} : [];
  for (index = l = 0, len1 = columnsMetaData.length; l < len1; index = ++l) {
    columnMetaData = columnsMetaData[index];
    if (bitmap[index]) {
      value = null;
    } else {
      value = valueParse(buffer, columnMetaData, options);
    }
    column = {
      value: value,
      metadata: columnMetaData
    };
    if (options.useColumnNames) {
      if (columns[columnMetaData.colName] == null) {
        columns[columnMetaData.colName] = column;
      }
    } else {
      columns.push(column);
    }
  }
  return {
    name: 'NBCROW',
    event: 'row',
    columns: columns
  };
};

module.exports = parser;
